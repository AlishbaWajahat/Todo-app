{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Chat UI Component Contracts (ChatKit Integration)",
  "description": "Component interfaces and contracts for ChatKit-based chat UI",
  "version": "2.0.0",
  "approach": "OpenAI ChatKit Integration",
  "note": "This feature uses OpenAI ChatKit (@openai/chatkit-react) instead of custom components. ChatKit handles message rendering, state management, auto-scroll, loading states, and error display automatically.",
  "components": [
    {
      "name": "ChatKitWrapper",
      "description": "Main wrapper component that integrates OpenAI ChatKit with our agent endpoint",
      "location": "frontend/src/components/chat/ChatKitWrapper.tsx",
      "props": {
        "type": "object",
        "properties": {},
        "description": "No props - self-contained component"
      },
      "responsibilities": [
        "Initialize ChatKit with useChatKit hook",
        "Configure ChatKit to connect to agent endpoint",
        "Provide custom fetch function for JWT authentication",
        "Configure ChatKit for no streaming (single response mode)",
        "Configure ChatKit for in-memory history only (no database persistence)",
        "Apply custom styling to match application theme",
        "Handle authentication (redirect if not logged in)"
      ],
      "chatKitConfiguration": {
        "api": {
          "url": "http://localhost:8000/api/v1/agent/chat",
          "fetch": "customFetch function that injects JWT token"
        },
        "startScreen": {
          "greeting": "How can I help you with your tasks today?",
          "prompts": [
            { "label": "Show my tasks", "prompt": "Show my tasks" },
            { "label": "Create a task", "prompt": "Create a task to..." }
          ]
        },
        "composer": {
          "placeholder": "Ask me anything about your tasks..."
        },
        "header": {
          "enabled": false
        },
        "history": {
          "enabled": true,
          "note": "In-memory only, no database persistence"
        }
      },
      "example": {
        "usage": "<ChatKitWrapper />"
      }
    }
  ],
  "utilities": [
    {
      "name": "chatkit-fetch",
      "description": "Custom fetch function for ChatKit that injects JWT authentication",
      "location": "frontend/src/lib/chatkit-fetch.ts",
      "exports": [
        {
          "name": "customFetch",
          "signature": "(url: string, options?: RequestInit) => Promise<Response>",
          "description": "Wrapper around fetch that adds JWT token to Authorization header",
          "implementation": {
            "authentication": "Retrieves JWT token from existing auth system",
            "headers": {
              "Authorization": "Bearer {token}",
              "Content-Type": "application/json"
            },
            "timeout": "30000ms using AbortController",
            "errorHandling": [
              "Network errors: User-friendly message",
              "401 Unauthorized: Redirect to login",
              "500 Server Error: Generic error message",
              "Timeout: 'Request timed out' message"
            ]
          },
          "errorHandling": {
            "networkError": {
              "message": "Connection failed. Please check your internet.",
              "action": "Display error in ChatKit"
            },
            "authError401": {
              "message": "Your session has expired. Please log in again.",
              "action": "Redirect to /login"
            },
            "serverError500": {
              "message": "Something went wrong. Please try again.",
              "action": "Display error in ChatKit"
            },
            "timeout": {
              "message": "Request timed out. Please try again.",
              "action": "Display error in ChatKit"
            }
          }
        }
      ]
    },
    {
      "name": "sanitization",
      "description": "DOMPurify integration for extra XSS protection",
      "location": "frontend/src/lib/chatkit-fetch.ts",
      "note": "ChatKit sanitizes by default, DOMPurify adds extra layer of security",
      "implementation": {
        "library": "dompurify",
        "config": {
          "ALLOWED_TAGS": [],
          "KEEP_CONTENT": true
        },
        "usage": "Sanitize agent responses before returning to ChatKit"
      }
    }
  ],
  "chatKitFeatures": {
    "providedByChatKit": [
      "Message rendering (user and agent messages)",
      "Message list with virtualization",
      "Auto-scroll to latest message",
      "Loading indicator ('Agent is thinking...')",
      "Error display (inline error messages)",
      "Input field with send button",
      "Enter key support",
      "Message timestamps",
      "Responsive design (mobile, tablet, desktop)",
      "Accessibility (ARIA labels, keyboard navigation)"
    ],
    "implementedByUs": [
      "JWT authentication via custom fetch",
      "Custom error handling (401, 500, timeout, network)",
      "Theme styling via CSS custom properties",
      "Connection to existing agent endpoint",
      "DOMPurify sanitization (extra layer)"
    ]
  },
  "styling": {
    "approach": "CSS custom properties and CSS modules",
    "location": "frontend/src/components/chat/ChatKitWrapper.module.css",
    "theme": {
      "description": "Map existing theme variables to ChatKit CSS custom properties",
      "requirements": [
        "Extract colors from tailwind.config.js",
        "Map to ChatKit CSS variables (--chatkit-primary, --chatkit-background, etc.)",
        "Match existing component patterns",
        "Responsive design (mobile 320px+, tablet 768px+, desktop 1024px+)"
      ]
    },
    "cssCustomProperties": {
      "--chatkit-primary": "Primary color from theme",
      "--chatkit-background": "Surface color from theme",
      "--chatkit-text": "Text color from theme",
      "--chatkit-border": "Border color from theme",
      "--chatkit-error": "Error color from theme"
    }
  },
  "dataFlow": {
    "userSendsMessage": [
      "1. User types message in ChatKit composer",
      "2. User presses Enter or clicks Send",
      "3. ChatKit calls customFetch with message",
      "4. customFetch retrieves JWT token from auth system",
      "5. customFetch adds Authorization header",
      "6. customFetch sends POST to /api/v1/agent/chat",
      "7. Backend processes request (agent → MCP tools → APIs)",
      "8. Backend returns AgentResponse",
      "9. customFetch sanitizes response with DOMPurify",
      "10. customFetch returns response to ChatKit",
      "11. ChatKit displays agent message",
      "12. ChatKit auto-scrolls to latest message"
    ],
    "errorHandling": [
      "1. Request fails (network, timeout, 401, 500)",
      "2. customFetch catches error",
      "3. customFetch returns user-friendly error message",
      "4. ChatKit displays error inline",
      "5. User can retry by sending new message"
    ]
  },
  "definitions": {
    "AgentRequest": {
      "type": "object",
      "required": ["user_id", "message"],
      "properties": {
        "user_id": {
          "type": "string",
          "description": "Authenticated user ID from JWT token"
        },
        "message": {
          "type": "string",
          "minLength": 1,
          "maxLength": 1000,
          "description": "User's natural language message"
        }
      }
    },
    "AgentResponse": {
      "type": "object",
      "required": ["response"],
      "properties": {
        "response": {
          "type": "string",
          "description": "Agent's natural language response"
        },
        "metadata": {
          "type": "object",
          "description": "Optional execution metadata"
        }
      }
    }
  },
  "accessibility": {
    "providedByChatKit": [
      "Keyboard navigation (Tab, Enter)",
      "ARIA labels for screen readers",
      "Focus management",
      "Color contrast (configurable via theme)",
      "Error announcements to screen readers"
    ],
    "additionalRequirements": [
      "Ensure custom theme colors meet WCAG AA standards",
      "Test with screen readers (NVDA, JAWS, VoiceOver)",
      "Verify keyboard navigation works with custom styling"
    ]
  },
  "performance": {
    "providedByChatKit": [
      "Message virtualization for large lists",
      "Optimized re-renders",
      "Smooth auto-scroll (60fps)",
      "Efficient state management"
    ],
    "targets": {
      "chatKitInitialization": "<2 seconds",
      "messageRendering": "<50ms per message",
      "autoScroll": "60fps smooth animation",
      "inputResponse": "<100ms to user interaction",
      "largeMessageList": "No lag with 100+ messages"
    }
  },
  "security": {
    "authentication": {
      "method": "JWT token in Authorization header",
      "retrieval": "From existing auth system (Feature 002)",
      "storage": "Never stored in component state or logged",
      "expiry": "401 response triggers redirect to login"
    },
    "sanitization": {
      "chatKitBuiltIn": "ChatKit sanitizes user input and agent responses automatically",
      "domPurify": "Extra layer of XSS protection for agent responses",
      "config": {
        "ALLOWED_TAGS": [],
        "KEEP_CONTENT": true
      }
    },
    "userIsolation": {
      "enforcement": "Backend agent endpoint enforces user_id from JWT",
      "mcpTools": "All MCP tools filter queries by user_id",
      "crossUserAccess": "Returns 404 (not 403) to prevent info leakage"
    }
  },
  "testing": {
    "componentTests": [
      "ChatKitWrapper renders without errors",
      "Custom fetch injects JWT token correctly",
      "Error handling displays user-friendly messages",
      "401 response redirects to login",
      "Theme styling applied correctly"
    ],
    "integrationTests": [
      "Send message → agent responds",
      "Create task via chat → task appears in database",
      "List tasks via chat → correct tasks displayed",
      "Network error → error message displayed",
      "Token expiry → redirect to login"
    ],
    "performanceTests": [
      "100+ messages render without lag",
      "Auto-scroll remains smooth",
      "No memory leaks",
      "p95 latency < 2 seconds"
    ]
  },
  "migration": {
    "fromCustomComponents": {
      "removed": [
        "ChatContainer component",
        "MessageList component",
        "MessageInput component",
        "Message component",
        "LoadingIndicator component",
        "useChat hook",
        "chat-api.ts (replaced by customFetch)"
      ],
      "added": [
        "ChatKitWrapper component",
        "chatkit-fetch.ts (custom fetch function)",
        "ChatKitWrapper.module.css (theme styling)"
      ],
      "benefits": [
        "Reduced code complexity (1 component vs 5 components + 1 hook)",
        "Production-tested UI from OpenAI",
        "Built-in accessibility and performance optimizations",
        "Automatic message rendering, auto-scroll, loading states",
        "Reduced maintenance burden"
      ]
    }
  },
  "notes": [
    "ChatKit handles all UI complexity - we only handle authentication and styling",
    "No streaming responses - ChatKit configured for single response mode",
    "No database persistence - chat history in-memory only",
    "Backend agent endpoint already exists (Feature 005) - no backend changes needed",
    "DELETE operation has known 80% success rate (acceptable per spec)",
    "ChatKit is SSR-safe when loaded with Next.js dynamic import"
  ]
}
