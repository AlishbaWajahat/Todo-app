# Data Model

**Feature**: Backend Core â€“ Task API & Database Layer
**Date**: 2026-02-03
**Phase**: Phase 1 - Design

## Overview

This document defines the data entities, their attributes, relationships, and validation rules for the task management system. The data model is designed to support the current MVP requirements while being compatible with future authentication integration.

---

## Entity: Task

**Description**: Represents a todo item that belongs to a user. Tasks can be created, updated, marked as complete, and deleted.

### Attributes

| Attribute | Type | Constraints | Default | Description |
|-----------|------|-------------|---------|-------------|
| `id` | Integer | Primary Key, Auto-increment | Auto-generated | Unique identifier for the task |
| `title` | String | Required, Max 200 chars | None | Task title/summary |
| `description` | String | Optional, Max 1000 chars | None | Detailed task description |
| `completed` | Boolean | Required | false | Completion status |
| `user_id` | Integer | Required, Positive | None | Owner of the task (for future auth) |
| `created_at` | DateTime | Required, UTC | Current timestamp | When task was created |
| `updated_at` | DateTime | Required, UTC | Current timestamp | When task was last modified |

### Field Details

#### id (Primary Key)
- **Type**: Integer (PostgreSQL SERIAL)
- **Constraints**: Primary key, auto-increment, not null
- **Validation**: Automatically generated by database
- **Usage**: Used in API endpoints as path parameter (`/api/v1/tasks/{task_id}`)

#### title
- **Type**: String (VARCHAR 200)
- **Constraints**: Required, not null, max 200 characters
- **Validation**:
  - Must not be empty string
  - Must not exceed 200 characters
  - Whitespace-only strings rejected
- **Usage**: Primary display text for task
- **Example**: "Complete project documentation"

#### description
- **Type**: String (VARCHAR 1000)
- **Constraints**: Optional, nullable, max 1000 characters
- **Validation**:
  - Can be null or empty string
  - Must not exceed 1000 characters if provided
- **Usage**: Additional details about the task
- **Example**: "Write comprehensive documentation for the API endpoints including examples and error cases"

#### completed
- **Type**: Boolean
- **Constraints**: Required, not null
- **Default**: false
- **Validation**: Must be true or false
- **Usage**: Indicates whether task is done
- **State Transitions**: false â†’ true (mark complete), true â†’ false (reopen)

#### user_id
- **Type**: Integer
- **Constraints**: Required, not null, positive integer
- **Validation**:
  - Must be positive integer (> 0)
  - No foreign key constraint in this phase
  - Will be validated against JWT token in future auth phase
- **Usage**: Associates task with a user for future authentication
- **Example**: 1, 42, 1000

#### created_at
- **Type**: DateTime (PostgreSQL TIMESTAMP)
- **Constraints**: Required, not null, UTC timezone
- **Default**: Current UTC timestamp at creation
- **Validation**: Automatically set by application, not user-provided
- **Usage**: Audit trail, sorting by creation date
- **Format**: ISO 8601 in API responses (e.g., "2026-02-03T10:30:00Z")

#### updated_at
- **Type**: DateTime (PostgreSQL TIMESTAMP)
- **Constraints**: Required, not null, UTC timezone
- **Default**: Current UTC timestamp at creation
- **Validation**: Automatically updated on every modification
- **Usage**: Audit trail, detecting stale data
- **Format**: ISO 8601 in API responses (e.g., "2026-02-03T15:45:30Z")

---

## SQLModel Implementation

### Database Model (table=True)

```python
from sqlmodel import SQLModel, Field
from typing import Optional
from datetime import datetime

class Task(SQLModel, table=True):
    """
    Task entity - represents a todo item.

    This model is used for database operations and includes all fields
    that are persisted to PostgreSQL.
    """
    id: Optional[int] = Field(default=None, primary_key=True)
    title: str = Field(max_length=200, min_length=1)
    description: Optional[str] = Field(default=None, max_length=1000)
    completed: bool = Field(default=False)
    user_id: int = Field(gt=0)  # Greater than 0
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)
```

### Request Schemas

```python
class TaskCreate(SQLModel):
    """
    Schema for creating a new task.

    Used in POST /api/v1/tasks request body.
    Does not include id, created_at, or updated_at (auto-generated).
    """
    title: str = Field(max_length=200, min_length=1)
    description: Optional[str] = Field(default=None, max_length=1000)
    completed: bool = Field(default=False)
    user_id: int = Field(gt=0)

class TaskUpdate(SQLModel):
    """
    Schema for updating an existing task.

    Used in PUT /api/v1/tasks/{task_id} request body.
    All fields required (full update).
    """
    title: str = Field(max_length=200, min_length=1)
    description: Optional[str] = Field(default=None, max_length=1000)
    completed: bool
    user_id: int = Field(gt=0)

class TaskPartialUpdate(SQLModel):
    """
    Schema for partially updating a task.

    Used in PATCH /api/v1/tasks/{task_id} request body.
    All fields optional (partial update).
    """
    title: Optional[str] = Field(default=None, max_length=200, min_length=1)
    description: Optional[str] = Field(default=None, max_length=1000)
    completed: Optional[bool] = None
    user_id: Optional[int] = Field(default=None, gt=0)
```

### Response Schema

```python
class TaskResponse(SQLModel):
    """
    Schema for task responses.

    Used in all API responses that return task data.
    Includes all fields including auto-generated ones.
    """
    id: int
    title: str
    description: Optional[str]
    completed: bool
    user_id: int
    created_at: datetime
    updated_at: datetime
```

---

## Validation Rules

### Title Validation
- **Required**: Yes
- **Min Length**: 1 character (after trimming whitespace)
- **Max Length**: 200 characters
- **Pattern**: Any Unicode characters allowed
- **Error**: 400 Bad Request with field-level error

**Valid Examples**:
- "Buy groceries"
- "Complete project documentation"
- "Call mom ðŸ“ž"

**Invalid Examples**:
- "" (empty string) â†’ 400 Bad Request
- "   " (whitespace only) â†’ 400 Bad Request
- "A" * 201 (too long) â†’ 400 Bad Request

### Description Validation
- **Required**: No (optional)
- **Min Length**: None (can be empty string)
- **Max Length**: 1000 characters
- **Pattern**: Any Unicode characters allowed
- **Error**: 400 Bad Request if exceeds max length

**Valid Examples**:
- null (not provided)
- "" (empty string)
- "Detailed description with multiple sentences..."

**Invalid Examples**:
- "A" * 1001 (too long) â†’ 400 Bad Request

### Completed Validation
- **Required**: Yes (defaults to false if not provided)
- **Type**: Boolean only
- **Values**: true or false
- **Error**: 400 Bad Request if not boolean

**Valid Examples**:
- true
- false

**Invalid Examples**:
- "true" (string) â†’ 400 Bad Request
- 1 (integer) â†’ 400 Bad Request
- null â†’ 400 Bad Request (if required in update)

### user_id Validation
- **Required**: Yes
- **Type**: Integer only
- **Range**: Must be positive (> 0)
- **Error**: 400 Bad Request if invalid

**Valid Examples**:
- 1
- 42
- 1000000

**Invalid Examples**:
- 0 â†’ 400 Bad Request (not positive)
- -1 â†’ 400 Bad Request (negative)
- "123" (string) â†’ 400 Bad Request
- 3.14 (float) â†’ 400 Bad Request

---

## Database Schema (PostgreSQL)

### Table: task

```sql
CREATE TABLE task (
    id SERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description VARCHAR(1000),
    completed BOOLEAN NOT NULL DEFAULT FALSE,
    user_id INTEGER NOT NULL CHECK (user_id > 0),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- Index on user_id for future filtering by authenticated user
CREATE INDEX idx_task_user_id ON task(user_id);

-- Index on created_at for sorting
CREATE INDEX idx_task_created_at ON task(created_at DESC);
```

**Note**: This schema will be created automatically by SQLModel when the application starts. The indexes may be added via Alembic migrations in a future phase.

---

## Relationships

### Current Phase (No Relationships)
- Task entity is standalone
- user_id is a plain integer field (no foreign key)
- No joins required for any operations

### Future Phase (With Authentication)
- Task will have foreign key to User table
- Relationship: User (1) â†’ Tasks (many)
- Cascade delete: When user is deleted, their tasks are deleted
- Query optimization: Filter tasks by user_id from JWT token

```python
# Future implementation (not in this phase)
class User(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    email: str = Field(unique=True, index=True)
    # ... other fields

class Task(SQLModel, table=True):
    # ... existing fields
    user_id: int = Field(foreign_key="user.id")  # Add foreign key
```

---

## State Transitions

### Task Lifecycle

```
[Created] â†’ completed=false
    â†“
[In Progress] â†’ completed=false (can update title, description)
    â†“
[Completed] â†’ completed=true (mark as done)
    â†“
[Reopened] â†’ completed=false (optional, can reopen)
    â†“
[Deleted] â†’ removed from database
```

**Valid Transitions**:
- Create: null â†’ completed=false
- Complete: completed=false â†’ completed=true
- Reopen: completed=true â†’ completed=false
- Update: Any field can be updated at any time
- Delete: Any state â†’ deleted

**No Invalid Transitions**: All state changes are allowed in this simple model.

---

## Data Integrity

### Constraints

1. **Primary Key**: id must be unique and not null
2. **Not Null**: title, completed, user_id, created_at, updated_at must not be null
3. **Check Constraint**: user_id must be positive (> 0)
4. **Length Constraints**: title â‰¤ 200 chars, description â‰¤ 1000 chars

### Validation Layers

1. **Pydantic Validation** (Application Layer):
   - Type checking (string, int, bool, datetime)
   - Length validation (min/max)
   - Range validation (user_id > 0)
   - Runs before database operations

2. **Database Constraints** (Database Layer):
   - NOT NULL constraints
   - CHECK constraints
   - Primary key uniqueness
   - Runs during INSERT/UPDATE

**Defense in Depth**: Both layers provide validation for data integrity.

---

## Example Data

### Sample Task Records

```json
[
  {
    "id": 1,
    "title": "Complete project documentation",
    "description": "Write comprehensive API documentation with examples",
    "completed": false,
    "user_id": 1,
    "created_at": "2026-02-03T10:00:00Z",
    "updated_at": "2026-02-03T10:00:00Z"
  },
  {
    "id": 2,
    "title": "Review pull requests",
    "description": null,
    "completed": true,
    "user_id": 1,
    "created_at": "2026-02-03T09:30:00Z",
    "updated_at": "2026-02-03T14:15:00Z"
  },
  {
    "id": 3,
    "title": "Deploy to production",
    "description": "Deploy backend API to cloud hosting",
    "completed": false,
    "user_id": 2,
    "created_at": "2026-02-03T11:00:00Z",
    "updated_at": "2026-02-03T11:00:00Z"
  }
]
```

---

## Migration Strategy

### Current Phase (No Migrations)
- SQLModel creates tables automatically on first run
- Use `SQLModel.metadata.create_all(engine)` in startup
- Simple and sufficient for MVP

### Future Phase (With Alembic)
- Add Alembic for version-controlled migrations
- Create initial migration from current schema
- Add foreign key constraint for user_id
- Add indexes for performance optimization

---

## Performance Considerations

### Indexing Strategy

**Current Phase**:
- Primary key index on id (automatic)
- No additional indexes needed for MVP scale

**Future Phase**:
- Index on user_id for filtering by authenticated user
- Index on created_at for sorting by date
- Composite index on (user_id, created_at) for common query pattern

### Query Patterns

**Current Phase** (No Auth):
- List all tasks: `SELECT * FROM task`
- Get task by ID: `SELECT * FROM task WHERE id = ?`
- Simple queries, no joins, fast performance

**Future Phase** (With Auth):
- List user's tasks: `SELECT * FROM task WHERE user_id = ?`
- Filtered queries, single-table, still fast with index

---

## Security Considerations

### Current Phase
- user_id is stored but not validated
- No authorization checks
- All tasks accessible to all clients

### Future Phase
- Validate user_id against JWT token
- Filter all queries by authenticated user_id
- Prevent cross-user data access
- Add 403 Forbidden for unauthorized access attempts

---

## Summary

**Entity Count**: 1 (Task)
**Total Fields**: 7 per task
**Relationships**: None (standalone entity)
**Validation Rules**: 4 field-level validations
**Database Constraints**: 3 (NOT NULL, CHECK, PRIMARY KEY)

**Complexity**: Low - Single entity, no relationships, straightforward validation
**Scalability**: Sufficient for hackathon MVP (<1000 users, <100k tasks)
**Extensibility**: Ready for future auth integration with minimal changes
